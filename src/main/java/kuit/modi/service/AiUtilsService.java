package kuit.modi.service;

import kuit.modi.dto.ai.AutoGenerateRequest;
import kuit.modi.dto.ai.LanguageStyleRequest;
import kuit.modi.dto.ai.StyledSummaryRequest;
import kuit.modi.dto.ai.SummaryRequest;
import kuit.modi.openai.OpenAiClient;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class AiUtilsService {
    private final OpenAiClient openAiClient;

    public String autoGenerateDiary(AutoGenerateRequest request) {
        String prompt = "제시된 태그들을 바탕으로 띄어쓰기 포함 200자 이내의 일기를 생성해줘. 태그들은 다음과 같아: " + String.join(", ", request.getTags());
        return openAiClient.ask(prompt);
    }

    public String summarizeDiary(SummaryRequest request) {
        String prompt = "다음 일기를 띄어쓰기 포함 40자 이내로 요약해줘:\n" + request.getContent();
        return openAiClient.ask(prompt);
    }

    public List<String> extractLanguageStyle(LanguageStyleRequest request) {
        String prompt = "다음 일기에 어울리는 감정 스타일을 3~4개 뽑아줘. 선택지는 '기쁨', '슬픔', '긴장감'과 같은 명사형으로 만들어줘. 일기 내용:\n" + request.getSummary();
        String response = openAiClient.ask(prompt);

        return Arrays.stream(response.split("\\r?\\n"))
                .map(String::trim)
                .filter(s -> !s.isEmpty())
                .map(s -> s.replaceFirst("^(\\d+\\.|-)+\\s*", ""))
                .collect(Collectors.toList());
    }

    public String getStyledSummary(StyledSummaryRequest request) {
        String prompt = "\"" + request.getStyle() + "\"이라는 언어 스타일을 적용해서 다음의 일기 요약을 띄어쓰기 포함 40자 이내로 다시 써줘: \n" + request.getSummary();
        return openAiClient.ask(prompt);
    }
}
